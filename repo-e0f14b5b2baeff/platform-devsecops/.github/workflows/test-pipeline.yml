name: Platform Infrastructure & Application Tests

on:
  pull_request:
    paths:
      - 'infra/**'
      - 'clusters/**'
      - 'apps/**'
      - 'policies/**'
      - 'Dockerfile'
  schedule:
    - cron: '0 2 * * *'  # nightly
  workflow_dispatch:

env:
  AWS_REGION: me-central-1
  CLUSTER_NAME: emirates-global-platform
  TF_IN_AUTOMATION: true

jobs:
  terraform-validate:
    name: üß± Terraform Validation & Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform Format
        working-directory: infra
        run: terraform fmt -check -recursive

      - uses: terraform-linters/setup-tflint@v3
      - name: Run TFLint
        working-directory: infra
        run: tflint --recursive

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/
          framework: terraform

  terratest:
    name: üß™ Terraform Unit Tests
    runs-on: ubuntu-latest
    needs: terraform-validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run Terratest
        run: |
          cd infrastructure-tests
          go test -v -timeout 30m ./...

  k8s-manifest-validation:
    name: ‚ò∏Ô∏è Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: Server-side Dry Run
        run: |
          for env in dev staging prod; do
            kubectl apply --dry-run=server -f clusters/$env/apps.yaml
          done
      - name: Kubeval Schema Validation
        uses: instrumenta/kubeval-action@master
        with:
          files: clusters/
      - name: Kube-score Best Practices
        run: kube-score score clusters/**/*.yaml || true

  container-scan:
    name: üîê Container Image Security Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        run: docker build -t emirates/app:${{ github.sha }} .
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: emirates/app:${{ github.sha }}
          format: table
          exit-code: '1'
          severity: 'HIGH,CRITICAL'

  performance-test:
    name: ‚ö° Performance Load Test (k6)
    runs-on: ubuntu-latest
    needs: container-scan
    steps:
      - uses: actions/checkout@v4
      - name: Run k6 test
        run: |
          docker run --rm -i grafana/k6 run - < tests/load/k6-script.js

  chaos-testing:
    name: üí• Chaos Testing (Pod Failure)
    runs-on: ubuntu-latest
    needs: performance-test
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: Configure Cluster Access
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
      - name: Deploy Chaos Mesh
        run: |
          kubectl get ns chaos-testing || kubectl create ns chaos-testing
          kubectl apply -f https://mirrors.chaos-mesh.org/latest/crd.yaml
          kubectl apply -f https://mirrors.chaos-mesh.org/latest/chaos-mesh.yaml
      - name: Run Pod Failure Chaos
        run: |
          kubectl apply -f tests/chaos/pod-failure.yaml
          sleep 300
          kubectl delete -f tests/chaos/pod-failure.yaml --ignore-not-found
      - name: Verify Service SLA
        run: |
          chmod +x tests/scripts/verify-sla.sh
          tests/scripts/verify-sla.sh

  smoke-tests:
    name: ü©∫ Smoke Tests (Post-Deployment)
    runs-on: ubuntu-latest
    needs: chaos-testing
    steps:
      - uses: actions/checkout@v4
      - name: Health Check Endpoints
        run: |
          curl -f https://staging.emirates-platform.example.com/healthz
          curl -f https://staging.emirates-platform.example.com/api/status
